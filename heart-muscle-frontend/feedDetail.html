<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>Title</title>

    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/image.css">

    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>


</head>

<script>

    // let apiUrl = "http://heartmuscle-env.eba-v2mbdfk2.ap-northeast-2.elasticbeanstalk.com/"
    let apiUrl = "http://localhost:8080"

    $(document).ready(function () {
        id = getParam('id');
        console.log(id)
        nowUsername = localStorage.getItem('username')
        console.log("nowUsername",nowUsername)
        getFeed(id);
        checkUser(id);
    })

    function checkUser() {
        $.ajax({
            type: "GET",
            url: apiUrl + `/feed/check/${id}`,
            beforeSend: function (xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.getItem('token'));
            },
            success: function (response) {
                alert(response)
                if ( response === "true") {
                    let tempHtml = `
                                    <button class="submit_btn" onclick="feedUpdate()">수정하기</button>
                                    <button class="submit_btn" onclick="feedDelete()">삭제하기</button>
                                    `
                    $('#update').append(tempHtml)
                } else {}
            }
        })

    }

    // $(document).ready(function () {
    //     test = localStorage.getItem('token')
    //     username = localStorage.getItem('username')
    //     if (test == null) {
    //         alert("테스트지롱")
    //     } else {
    //         alert(localStorage.getItem('username'))
    //     }
    // });

    function getParam(name) {
        var results = new RegExp('[\?&amp;]' + name + '=([^&amp;#]*)').exec(window.location.href);
        console.log(results)
        return results[1] || 0;
    }

    var search = location.search
    console.log("search: ", search)
    var params = new URLSearchParams(search);
    console.log("params: ", params)
    var getType = params.get('id');
    console.log("getType: ", getType)


    function getFeed() {
        $.ajax({
            type: "GET",
            url: apiUrl + `/feed/${id}`,
            success: function (response) {
                // console.log("nowID:", response[user_id]);

                $("#title").html(response['title']);
                $("#content").html(response['content']);
                $("#image").attr("src", response['imageUrl']);
                $("#comment-list").empty();
                for (let i = 0; i < response['comments'].length; i++) {
                    makeListComment(response['comments'][i])

                }
            }
        })

    }

    function writeComment() {
        let comment = {
            "id":id,
            "comment":$("#comment").val()
        }
        console.log(comment)
        $.ajax({
            type: "POST",
            url: apiUrl + `/feed/comment`,
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify(comment),
            success: function (response) {
                alert("댓글이 작성되었습니다!!");
                getFeed();
                // 댓글창만 새로고침 되는 방법 찾으면 그걸로 바꾸기
                window.location.reload()
            }
        })
    }

    function makeListComment(comment) {
        let tempHtml = `
                        <div class="comment_container">
                            <div class="comment" id="comment-list-ajax-post37">
                                <div class="comment-detail">
                                    <div>${comment['comment']}</div>
                                </div>
                            </div>
                        </div>`;
        $("#comment-list").append(tempHtml);
    }

    function feedUpdate() {
        id = getParam('id');
        window.location.href = 'feedUpdate.html?id=' + id
    }

    function feedDelete() {
        $.ajax({
            type: "DELETE",
            url: apiUrl + `/feed/${id}`,
            success: function (response) {
                alert("피드가 삭제되었습니다!");
                window.location.href = "/feedList.html"
            }
        })
    }


</script>

<body>


<section id="container">


    <header id="header">
        <section class="inner">

            <h1 class="logo">
                <a href="index.html">
                    <div class="sprite_insta_icon"></div>
                    <div class="sprite_write_logo"></div>
                </a>
            </h1>

            <div class="search_box">
                <input type="text" placeholder="검색" id="search-field">

                <div class="fake_field">
                    <span class="sprite_small_search_icon"></span>
                    <span>검색</span>
                </div>
            </div>

            <div class="right_icons">
                <a href="feedSave.html"><div class="sprite_camera_icon"></div></a>
                <a href="login.html"><div class="sprite_compass_icon"></div></a>
                <a href="follow.html"><div class="sprite_heart_icon_outline"></div></a>
                <a href="profile.html"><div class="sprite_user_icon_outline"></div></a>
            </div>

        </section>

    </header>

    <div class="hidden_menu">
        <div class="scroll_inner">
            <div class="user">
                <div class="thumb_img"><img src="imgs/thumb.jpeg" alt="프로필사진"></div>
                <div class="id">kindtigerrr</div>
            </div>

            <div class="user">
                <div class="thumb_img"><img src="imgs/thumb.jpeg" alt="프로필사진"></div>
                <div class="id">kindtigerrr</div>
            </div>
            <div class="user">
                <div class="thumb_img"><img src="imgs/thumb.jpeg" alt="프로필사진"></div>
                <div class="id">kindtigerrr</div>
            </div>
            <div class="user">
                <div class="thumb_img"><img src="imgs/thumb.jpeg" alt="프로필사진"></div>
                <div class="id">kindtigerrr</div>
            </div>
            <div class="user">
                <div class="thumb_img"><img src="imgs/thumb.jpeg" alt="프로필사진"></div>
                <div class="id">kindtigerrr</div>
            </div>
            <div class="user">
                <div class="thumb_img"><img src="imgs/thumb.jpeg" alt="프로필사진"></div>
                <div class="id">kindtigerrr</div>
            </div>
            <div class="user">
                <div class="thumb_img"><img src="imgs/thumb.jpeg" alt="프로필사진"></div>
                <div class="id">kindtigerrr</div>
            </div>
            <div class="user">
                <div class="thumb_img"><img src="imgs/thumb.jpeg" alt="프로필사진"></div>
                <div class="id">kindtigerrr</div>
            </div>
            <div class="user">
                <div class="thumb_img"><img src="imgs/thumb.jpeg" alt="프로필사진"></div>
                <div class="id">kindtigerrr</div>
            </div>
            <div class="user">
                <div class="thumb_img"><img src="imgs/thumb.jpeg" alt="프로필사진"></div>
                <div class="id">kindtigerrr</div>
            </div>

        </div>
    </div>


    <section id="main_container">
        <div class="inner">

            <div class="contents_box" id="feed">
                <article class="contents">
                    <header class="top">
                        <div class="user_container">
                            <div class="profile_img">
                                <img src="imgs/thumb.jpeg" alt="프로필이미지">
                            </div>
                            <div class="user_name">
                                <div class="nick_name m_text">KindTiger</div>
                                <div class="country s_text">Seoul, South Korea</div>
                            </div>

                        </div>

                        <div class="sprite_more_icon" data-name="more">
                            <ul class="toggle_box">
                                <li><input type="submit" class="follow" value="팔로우" data-name="follow"></li>
                                <li>수정</li>
                                <li>삭제</li>
                            </ul>
                        </div>
                    </header>

                    <div class="img_section">
                        <div class="trans_inner">
                            <div><img id="image" class="image-size" alt="visual01"></div>
                        </div>
                    </div>

                    <div class="comment_container">
                        <div class="comment" id="comment-list-ajax-post37">
                            <div class="comment-detail">
                                <div id="title"></div>
                            </div>
                        </div>
                    </div>

                    <div class="comment_container">
                        <div class="comment" id="comment-list-ajax-post37">
                            <div class="comment-detail">
                                <div id="content"></div>
                            </div>
                        </div>
                    </div>

                    <div id="comment-list"></div>

                    <div class="comment_container">
                        <div class="comment" id="comment-list-ajax-post37">
                            <div class="comment-detail">
                                <div>강아지가 너무 귀여워요~!</div>
                            </div>
                        </div>
                    </div>

                    <div class="comment_field" id="add-comment-post37">
                        <input type="text" id="comment" placeholder="댓글달기...">
                        <div class="upload_btn m_text" data-name="comment" onclick="writeComment()">게시</div>
                    </div>
                    <div id="update"></div>
                </article>


            </div>
            <input type="hidden" id="page" value="1">



        </div>
    </section>



</section>








<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="js/main.js"></script>
</body>
</html>